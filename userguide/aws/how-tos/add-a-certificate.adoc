= How To Add a Certificate

== Overview


This document provides information about setting up HTTPS that applies to all of the AWS Kill Bill architectures: single-tier, multi-tier, and cloud formation.

HTTPS is based on the use of a verification document called a *certificate*. For an explanation of certificates see https://docs.killbill.io/latest/aws/explanations/https.html[About HTTPS and Certificates].

For temporary use, you can sometimes create a *self-signed* certificate, in which you are your own CA. Most browsers will frown on this, since you are simply vouching for yourself, but it may allow you to get started with security. We will not consider this option in this document.

If you own a domain, your domain provider can serve as your CA. If you don't have a domain, you can purchase one for very low cost from a domain provider such as https://www.godaddy.com/[Godaddy]. When you obtain a domain you need to prove your identity, so your domain provider can trust you. To demonstrate this trust you will need a CNAME.

The remainder of this document has three parts:

. <<step0, Preliminary Concepts>>
. <<step1, Obtaining a Certificate>>
. <<step2, Testing and Verification>>

[[step0]]
== Preliminary concepts

=== CNAMEs

A CNAME, or *Canonical Name*, is an identifier that links your CA to the resources that you are protecting with your certificate. You will be protecting public access to your instances of Kaui and Kill Bill through your load balancer, identified by its DNS name. The CNAME will link your domain to the load balancer. If your domain is `mydomain.com` your CNAME might look like `kaui.mydomain.com`. This will direct browsers to your verified domain, and then, through your CNAME, to your AWS resources.

The CNAME is part of your domain's DNS profile, and your domain provider should have instructions for setting it up. These instructions should ask you to enter two strings called `Name` and `Value`. These strings will be obtained during the certificate generation process.

=== Protocol and Port Setup

Your AWS security group by default provides rules giving access to Kaui and Kill Bill using the HTTP protocol and a specified port number. For HTTPS you will need additional rules with the new protocol and a new port number.

=== Validation

When you create a new certificate you will need to validate your certificate. This identifies the trust hierarchy for the certificate. You may need to setup a temporary CNAME for this purpose, and you may need to provide temporary access via an extra port in your security group.

[[step1]]
== Step 1: Obtaining a Certificate

There are many ways to obtain a certificate that you can use to protect a particular resource. Here we will describe two that may be of use in particular Kill Bill scenarios running on AWS. These are:

1. Using the AWS Certificate Manager
2. Using the free CA *Let's Encrypt*

=== Using the AWS Certificate Manager (ACM)

The AWS Certificate Manager (ACM) offers a straightforward way to provide SSL/TLS protection for AWS resources such as load balancers. This is recommended when using the multi-tier or cloud formation installation options. For these cases there is no extra cost for using ACM certificates. 

==== 1. Request a Certificate

If you are on a page that is asking for your certificate, click on *Request a new Certificate from ACM*. Otherwise, select *Security, Identity, and Compliance*, then *Certificate Manager* from the Services menu. You will be taken to the main page of the ACM. Initially this will probably show that you have no certificates. On the left menu, click *Request a Certificate*.

The next page will give you the option to request a public or private certificate. The private option may be grayed out. Click *Request a Public Certificate*. The page that appears will ask you to specify several parameters, including one or more domain names and a validation method.

image::https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-request-certificate.png[align=center]

==== 2. Setup a CNAME

To validate your certificate, you must first setup a *validation* CNAME. The values to use for the CNAME will be seen shortly.  You will then create the CNAME that you will actually use to access the system.

Enter your domain name, using the wildcard format. Then click *Next*. On the following page, select *DNS Validation*. The next page gives you the chance to assign one or more tags to your certificate. These are optional and can be skipped. Finally, you are given a chance to review your request. Check everything, then click *Confirm and Request*. The *Validation* page will appear.

image::https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-cert-validation-1.png[align=center]

At the bottom you will see your domain name with a status of *Pending Validation*. Click the triangle next to your domain name. The display will expand to show the values that you must use to create your validation CNAME.

image::https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/ELB-cert-validation-2.png[align=center]

The two strings labeled `Name` and `Value` should be copied to the two required entries for your CNAME. Copy these long strings carefully. Do not include any trailing periods. There is an option to save these strings in a file so they may be copied more easily, or stored for a later time.

Your second CNAME is much simpler. The `Name` entry will be `kaui`. The `Value` entry will be simply your domain name, e.g., `mydomain.com`.

==== 3. Create and Validate your Certificate

When your CNAMEs are set, return to ACM and click *Continue*. The display changes to show that your certificate is *Pending Validation*. The certificate should now appear also on the main ACM page. When (and if) it is validated, the status will change to *Success*. *This may take several hours or more.* A short time later it will change again to *Issued*.

NOTE: Your validation CNAME will not be used again for normal HTTPS access, but it *will* be needed to revalidate your certificate when it is renewed.

=== Using Let's Encrypt (with Certbot)

https://letsencrypt.org[Let's Encrypt] is a root CA that is free to use. Certificates based on `Let's Encrypt` can be created using the application `certbot`. This approach is useful when using a third-party load balancer like `nginx`, which cannot be protected with ACM certificates. This is the load balancer used with the single-tier Kill Bill option.`Let's Encrypt` can be used free of charge.

`Certbot` is pre-installed in the latest Kill Bill AMI, but if you need a different version of `certbot`, this is also available through the new package manager `snap`. This package manager is also preinstalled in the Kill Bill AMI.

To setup a certificate using `certbot`, perform the following steps. This discussion assumes you are using `nginx`:

==== 1. Create a CNAME

Create a CNAME, following instructions from your domain provider. You will be asked to provide two strings, `Name` and `Value`. The `Name` string is simply `kaui`. The `Value` string is the *Public IPV4 DNS* name for your EC2 instance, for example, `ec2-3-238-230-120.compute-1.amazonaws.com`. Note that the IPV4 address alone will *not* work.

==== 2. Add your CNAME to the `nginx` configuration file

This step tells `nginx` to forward HTTPS traffic via your CNAME.
        
First, login to your EC2 instance.

Next, using a text editor of your choosing, edit the file `/etc/nginx/sites-enabled/killbill.conf`. You will need to use `sudo` to edit this file.

This file contains two server blocks. The second block contains the lines:

```
server {
    listen 443;
    server_name _;
```
Replace the underscore after `server_name` with your CNAME:

```
server {
    listen 443;
    server_name kaui.mydomain.com;
```

Save the modified file, then reload it with the following command:

`sudo nginx -s reload`

==== 3. Enable HTTP on port 80 (temporarily)

Go to your EC2 dashboard and add a new inbound rule to your security group as follows: Type: HTTP, Protocol: TCP, Port Range: 80, Source: 0.0.0.0/0. Your inbound rules should now look like this:

image::https://github.com/killbill/killbill-docs/raw/v3/userguide/assets/aws/single-ami-inbound-port-80.png[align=center]

This is just to allow `certbot` to create your certificate. After the certificate is created, we recommend that you remove this rule to maintain security.

==== 4. Create and Install the Certificate

Run `certbot` using the following command:

`sudo certbot --nginx`

Respond to any questions that are asked. If all goes well, you will see a message like:

```
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/deployment.killbill.io/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/deployment.killbill.io/privkey.pem
   Your cert will expire on 2021-07-11. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot again
   with the "certonly" option. To non-interactively renew *all* of
   your certificates, run "certbot renew"
```

If the message does not appear, review the above steps carefully. If needed you can also try the https://certbot.eff.org/help/[certbot help page].

[[step2]]
== Step 2: Testing and Renewal

When your certificate is installed, you should be able to access Kaui from you browser using `https://` followed by your CNAME as the address. The browser should indicate that the site is secure.

When your certificate is successfully installed, you can edit your security groups again to remove the access through port 80.

The `Let's Encrypt` certifcates are only valid 90 days and will therefore neeed to be renewed. `certbot` will create a cron entry under `/etc/cron.d/certbot` to make this process automatic.

The ACM certificates are good for approximately one year. They will renew automatically, provided that:

1. It is currently associated with an AWS load balancer
2. Your validation CNAME is still setup in your domain's DNS profile
 

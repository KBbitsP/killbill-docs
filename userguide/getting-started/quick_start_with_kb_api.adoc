
= Quick Start with the Kill Bill API

This guide explains how to get familiar with the Kill Bill API by performing the following tasks:  

. <<step1, Create a tenant>>
. <<step2, Set up a simple catalog and plan>>
. <<step3, Create an account>> 
. <<step4, Add a payment method to the account>>
. <<step5, Set up a subscription for the account>>
. <<step6, View the generated invoice>>

== Before You Begin

Make sure you have installed Kill Bill and Kaui and launched them per the https://docs.killbill.io/latest/getting_started.html.html[_Getting Started_] guide. 

== Additional Resources

* https://killbill.github.io/slate[_API Reference_]

* https://docs.killbill.io/latest/userguide_kaui.html[_Kaui Guide_] 

* https://docs.killbill.io/latest/Kill-Bill-Glossary.html[_Kill Bill Glossary_]
 
[step1]
== Step 1. Create a Tenant

Kill Bill supports multi-tenancy, where each https://docs.killbill.io/latest/Kill-Bill-Glossary.html#tenant[tenant^] has its own data, configuration, and so forth. This section explains how to create a tenant via the Kill Bill API.

[[All the code in this section is from the Tenants section in the API docs.]]

++++
<ul class="nav nav-tabs" id="tutorial-step1" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step1" data-toggle="tab" href="#curl-step1" role="tab" aria-controls="curl-step1" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step1" data-toggle="tab" href="#java-step1" role="tab" aria-controls="java-step1" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step1" data-toggle="tab" href="#ruby-step1" role="tab" aria-controls="ruby-step1" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step1" data-toggle="tab" href="#python-step1" role="tab" aria-controls="python-step1" aria-selected="false">Python</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step1">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step1" role="tabpanel" aria-labelledby="curl-tab-step1">
++++
[source,bash]
----
curl -v \
    -X POST \
    -u admin:password \
    -H "Content-Type: application/json" \
    -H "Accept: application/json" \
    -H "X-Killbill-CreatedBy: demo" \
    -H "X-Killbill-Reason: demo" \
    -H "X-Killbill-Comment: demo" \
    -d '{ "apiKey": "bob", "apiSecret": "lazar"}' \
    "http://127.0.0.1:8080/1.0/kb/tenants"
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="java-step1" role="tabpanel" aria-labelledby="java-tab-step1">
++++
[source,java]
----
import org.killbill.billing.client.api.gen.TenantApi;
protected TenantApi tenantApi;

UUID tenantId = null;
String externalKey = null;
String apiKey = "bob";
String apiSecret = "lazar";
ImmutableList<AuditLog> EMPTY_AUDIT_LOGS = ImmutableList.<AuditLog>of();

Tenant body = new Tenant(tenantId,
                         externalKey,
                         apiKey,
                         apiSecret,
                         EMPTY_AUDIT_LOGS);

tenantApi.createTenant(body, requestOptions);
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="ruby-step1" role="tabpanel" aria-labelledby="ruby-tab-step1">
++++
[source,ruby]
----
tenant = KillBillClient::Model::Tenant.new
tenant.external_key = "demo_external_key"
tenant.api_key = "demo_api_key"
tenant.api_secret = "demo_api_secret"

use_global_default = true
user = "demo"
reason = nil
comment = nil

tenant.create(use_global_default,
              user,
              reason,
              comment,
              options)
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="python-step1" role="tabpanel" aria-labelledby="python-tab-step1">
++++
[source,python]
----
tenantApi = killbill.api.TenantApi()

body = Tenant(api_key='demo_api_key', api_secret='demo_api_secret')

tenantApi.create_tenant(body, created_by='demo')
----
++++
  </div>
</div>
++++

[step2]
== Step 2. Set Up a Simple Catalog and Plans

The Kill Bill https://docs.killbill.io/latest/Kill-Bill-Glossary.html#catalog[catalog^] contains https://docs.killbill.io/latest/Kill-Bill-Glossary.html#products[products^] and https://docs.killbill.io/latest/Kill-Bill-Glossary.html#plans[plans^] definitions. This XML configuration file is really powerful and offers various options for handling https://docs.killbill.io/latest/Kill-Bill-Glossary.html#trial_phase[trials^], https://docs.killbill.io/latest/Kill-Bill-Glossary.html#addons[add-ons^], https://docs.killbill.io/latest/Kill-Bill-Glossary.html#upgrade[upgrades^] / https://docs.killbill.io/latest/Kill-Bill-Glossary.html#downgrade[downgrades^], and so forth. (For more information on the Kill Bill catalog, see the https://docs.killbill.io/latest/userguide_subscription.html#components-catalog[Catalog] section in the _Subscription Billing_ guide.)

For this tutorial, instead of starting with the XML catalog, you'll learn how to create a simple catalog using the API as well as adding one plan. 

[NOTE]
*Note:* The simple catalog supports a _subset_ of the regular XML catalog features and isn't intended to serve as a catalog in production. For more details on the simple catalog, see the https://killbill.github.io/slate/#catalog-simple-plan["Simple Plan"] section in the _API Reference_.

//All the code in this section is from the Simple Plan section in the API docs.

++++
<ul class="nav nav-tabs" id="tutorial-step1" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step1" data-toggle="tab" href="#curl-step2" role="tab" aria-controls="curl-step2" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step2" data-toggle="tab" href="#java-step2" role="tab" aria-controls="java-step2" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step2" data-toggle="tab" href="#ruby-step2" role="tab" aria-controls="ruby-step2" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step2" data-toggle="tab" href="#python-step2" role="tab" aria-controls="python-step2" aria-selected="false">Python</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step1">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step2" role="tabpanel" aria-labelledby="curl-tab-step2">
++++
[source,bash]
----
curl -v \
    -X POST \
    -u admin:password \
    -H "X-Killbill-ApiKey: bob" \
    -H "X-Killbill-ApiSecret: lazar" \
    -H "Content-Type: application/json" \
    -H "Accept: application/json" \
    -H "X-Killbill-CreatedBy: demo" \
    -H "X-Killbill-Reason: demo" \
    -H "X-Killbill-Comment: demo" \
    -d '{ "planId": "standard-monthly", "productName": "Standard", "productCategory": "BASE", "currency": "USD", "amount": 24.95, "billingPeriod": "MONTHLY", "trialLength": 0, "trialTimeUnit": "UNLIMITED"}' \
    "http://localhost:8080/1.0/kb/catalog/simplePlan"
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="java-step2" role="tabpanel" aria-labelledby="java-tab-step2">
++++
[source,java]
----
//I'm not sure if I declared BigDecimal amount correctly.

import org.killbill.billing.client.api.gen.CatalogApi;
protected CatalogApi catalogApi;

String planId = "standard-monthly";
String productName = "Standard";
Integer trialLength = 0;

SimplePlan body = new SimplePlan(planId, 
                                 productName, 
                                 ProductCategory.BASE, 
                                 Currency.USD, 
                                 BigDecimal.("24.95"), 
                                 BillingPeriod.MONTHLY, 
                                 trialLength, 
                                 TimeUnit.UNLIMITED, 
                                 ImmutableList.<String>of())

catalogApi.addSimplePlan(body, requestOptions);
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="ruby-step2" role="tabpanel" aria-labelledby="ruby-tab-step2">
++++
[source,ruby]
----
simple_plan                  = KillBillClient::Model::SimplePlanAttributes.new
simple_plan.plan_id          = 'standard-monthly'
simple_plan.product_name     = 'Standard'
simple_plan.product_category = 'BASE'
simple_plan.currency         = 'USD'
simple_plan.amount           = 24.95
simple_plan.billing_period   = 'MONTHLY'
simple_plan.trial_length     = 0
simple_plan.trial_time_unit  = 'UNLIMITED'

KillBillClient::Model::Catalog.add_tenant_catalog_simple_plan(simple_plan,
                                                              user,
                                                              reason,
                                                              comment,
                                                              options)
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="python-step2" role="tabpanel" aria-labelledby="python-tab-step2">
++++
[source,python]
----
catalogApi = killbill.api.CatalogApi()
body = SimplePlan(plan_id='standard-monthly',
                  product_name='Standard',
                  product_category='BASE',
                  currency='USD',
                  amount=24.95,
                  billing_period='MONTHLY',
                  trial_length=0,
                  trial_time_unit='UNLIMITED')
catalogApi.add_simple_plan(body, created_by, api_key, api_secret)
----
++++
  </div>
</div>
++++

[NOTE]
*Note:* You can repeat this API call to create another plan. For more information, see https://killbill.github.io/slate/#catalog-simple-plan[Simple Plan] in the API.

[step3]
== Step 3. Create an Account

In this section, we will create an https://docs.killbill.io/latest/Kill-Bill-Glossary.html#account[account^] for a customer, which stores the data your organization uses to transact business with a customer. To keep it simple, we will create an account with a minimum of information.

++++
<ul class="nav nav-tabs" id="tutorial-step3" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step3" data-toggle="tab" href="#curl-step3" role="tab" aria-controls="curl-step3" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step3" data-toggle="tab" href="#java-step3" role="tab" aria-controls="java-step3" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step3" data-toggle="tab" href="#ruby-step3" role="tab" aria-controls="ruby-step3" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step3" data-toggle="tab" href="#python-step3" role="tab" aria-controls="python-step3" aria-selected="false">Python</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="go-tab-step3" data-toggle="tab" href="#go-step3" role="tab" aria-controls="go-step3" aria-selected="false">Go</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="php-tab-step3" data-toggle="tab" href="#php-step3" role="tab" aria-controls="php-step3" aria-selected="false">PHP</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step1">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step3" role="tabpanel" aria-labelledby="curl-tab-step3">
++++
[source,bash]
----
curl -v \
     -X POST \
     -u admin:password \
     -H 'X-Killbill-ApiKey: bob' \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: tutorial' \
     -H 'Content-Type: application/json' \
     -d '{ "name": "John Doe", "currency": "USD"}' \
     'http://127.0.0.1:8080/1.0/kb/accounts'
----
++++
    <p>The cURL output should return a <code>Location</code> header which contains the unique identifier (ID) of this account: <code>Location: http://127.0.0.1:8080/1.0/kb/accounts/1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8</code></p>
  </div>
  <div class="tutorial-tab tab-pane fade" id="java-step3" role="tabpanel" aria-labelledby="java-tab-step3">
++++
[source,java]
----
import org.killbill.billing.catalog.api.Currency;
import org.killbill.billing.client.KillBillClientException;
import org.killbill.billing.client.KillBillHttpClient;
import org.killbill.billing.client.RequestOptions;
import org.killbill.billing.client.api.gen.AccountApi;
import org.killbill.billing.client.model.gen.Account;

KillBillHttpClient client = new KillBillHttpClient("http://127.0.0.1:8080",
                                                   "admin",
                                                   "password",
                                                   "bob",
                                                   "lazar");
AccountApi accountApi = new AccountApi(client);

Account body = new Account();
body.setName("John Doe");
body.setCurrency(Currency.USD);

RequestOptions requestOptions = RequestOptions.builder()
                                              .withCreatedBy("tutorial")
                                              .build();
Account account = accountApi.createAccount(body, requestOptions);
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="ruby-step3" role="tabpanel" aria-labelledby="ruby-tab-step3">
++++
[source,ruby]
----
require 'killbill_client'

KillBillClient.url = 'http://127.0.0.1:8080'

options = {
  :username => 'admin',
  :password => 'password',
  :api_key => 'bob',
  :api_secret => 'lazar'
}

body = KillBillClient::Model::Account.new
body.name = 'John Doe'
body.currency = 'USD'

account = body.create('tutorial', nil, nil, options)
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="python-step3" role="tabpanel" aria-labelledby="python-tab-step3">
++++
[source,python]
----
import killbill

killbill.configuration.base_uri = 'http://127.0.0.1:8080'
killbill.configuration.username = 'admin'
killbill.configuration.password = 'password'

account_api = killbill.api.AccountApi()
body = killbill.models.account.Account(name='John Doe', currency='USD')
account = account_api.create_account(body, 'tutorial', 'bob', 'lazar')
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="go-step3" role="tabpanel" aria-labelledby="go-tab-step3">
++++
[source,go]
----

import (
	"context"
	"encoding/base64"
	"github.com/go-openapi/runtime"
	httptransport "github.com/go-openapi/runtime/client"
	"github.com/go-openapi/strfmt"
	"github.com/killbill/kbcli/kbclient"
	"github.com/killbill/kbcli/kbclient/account"
	"github.com/killbill/kbcli/kbmodel"
)

trp := httptransport.New("127.0.0.1:8080", "", nil)

authWriter := runtime.ClientAuthInfoWriterFunc(
	func(r runtime.ClientRequest, _ strfmt.Registry) error {
		encoded := base64.StdEncoding.EncodeToString([]byte("admin:password"))
		if err := r.SetHeaderParam("Authorization", "Basic "+encoded); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiKey", "bob"); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiSecret", "lazar"); err != nil {
			return err
		}
		return nil
	})

createdBy := "tutorial"
defaults := kbclient.KillbillDefaults{
	CreatedBy: &createdBy,
}

client := kbclient.New(trp, strfmt.Default, authWriter, defaults)
body := &kbmodel.Account{
	Name:     "John Doe",
	Currency: "USD",
}

newAccount, err := client.Account.CreateAccount(
	context.Background(),
	&account.CreateAccountParams{
		Body:                  body,
		ProcessLocationHeader: true,
	})
if err == nil {
	print(newAccount.GetPayload().AccountID)
}
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="php-step3" role="tabpanel" aria-labelledby="php-tab-step3">
++++
[source,php]
----
require_once(__DIR__ . '/vendor/autoload.php');

$config = Killbill\Client\Swagger\Configuration::getDefaultConfiguration();
$config->setHost('http://127.0.0.1:8080')
       ->setUsername('admin')
       ->setPassword('password')
       ->setApiKey('X-Killbill-ApiKey', 'bob')
       ->setApiKey('X-Killbill-ApiSecret', 'lazar');

$accountApi = new Killbill\Client\Swagger\Api\AccountApi(null, $config);

$accountData = new Killbill\Client\Swagger\Model\Account();
$accountData->setName('John Doe');
$accountData->setCurrency('USD');

$account = $accountApi->createAccount($accountData, 'tutorial', NULL, NULL);
----
++++
  </div>
</div>
++++

[step4]
== Step 4. Add a Payment Method to the Account

To pay its https://docs.killbill.io/latest/Kill-Bill-Glossary.html#invoice[invoices^], an account must have at least one https://docs.killbill.io/latest/Kill-Bill-Glossary.html#payment_method[payment method^] saved. This section explains how to add a payment method to a customer account.

For simplicity, we will create an offline payment method—checks—for the account we created in step 1.

[NOTE]
*Note:* Replace `1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8` below with the ID of your account.

++++
<ul class="nav nav-tabs" id="tutorial-step4" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step4" data-toggle="tab" href="#curl-step4" role="tab" aria-controls="curl-step4" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step4" data-toggle="tab" href="#java-step4" role="tab" aria-controls="java-step4" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step4" data-toggle="tab" href="#ruby-step4" role="tab" aria-controls="ruby-step4" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step4" data-toggle="tab" href="#python-step4" role="tab" aria-controls="python-step4" aria-selected="false">Python</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="go-tab-step4" data-toggle="tab" href="#go-step4" role="tab" aria-controls="go-step4" aria-selected="false">Go</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="php-tab-step4" data-toggle="tab" href="#php-step4" role="tab" aria-controls="php-step4" aria-selected="false">PHP</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step2">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step4" role="tabpanel" aria-labelledby="curl-tab-step4">
++++
[source,bash]
----
curl -v \
     -X POST \
     -u admin:password \
     -H 'X-Killbill-ApiKey: bob' \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: tutorial' \
     -H 'Content-Type: application/json' \
     -d '{ "pluginName": "__EXTERNAL_PAYMENT__" }' \
     http://127.0.0.1:8080/1.0/kb/accounts/1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8/paymentMethods?isDefault=true 
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="java-step4" role="tabpanel" aria-labelledby="java-tab-step4">
++++
[source,java]
----
import java.util.UUID;

import org.killbill.billing.client.KillBillClientException;
import org.killbill.billing.client.KillBillHttpClient;
import org.killbill.billing.client.RequestOptions;
import org.killbill.billing.client.api.gen.AccountApi;
import org.killbill.billing.client.model.gen.PaymentMethod;

KillBillHttpClient client = new KillBillHttpClient("http://127.0.0.1:8080",
                                                   "admin",
                                                   "password",
                                                   "bob",
                                                   "lazar");
AccountApi accountApi = new AccountApi(client);

PaymentMethod body = new PaymentMethod();
body.setIsDefault(true);
body.setPluginName("__EXTERNAL_PAYMENT__");

RequestOptions requestOptions = RequestOptions.builder()
                                              .withCreatedBy("tutorial")
                                              .build();
UUID accountId = UUID.fromString("1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8");
PaymentMethod paymentMethod = accountApi.createPaymentMethod(accountId,
                                                             body,
                                                             true,
                                                             null,
                                                             null,
                                                             null,
                                                             requestOptions);
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="ruby-step4" role="tabpanel" aria-labelledby="ruby-tab-step4">
++++
[source,ruby]
----
require 'killbill_client'

KillBillClient.url = 'http://127.0.0.1:8080'

options = {
  :username => 'admin',
  :password => 'password',
  :api_key => 'bob',
  :api_secret => 'lazar'
}

body = KillBillClient::Model::PaymentMethod.new
body.account_id = '1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8'
body.plugin_name = '__EXTERNAL_PAYMENT__'

pm = body.create(true, 'tutorial', nil, nil, options)
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="python-step4" role="tabpanel" aria-labelledby="python-tab-step4">
++++
[source,python]
----
import killbill

killbill.configuration.base_uri = 'http://127.0.0.1:8080'
killbill.configuration.username = 'admin'
killbill.configuration.password = 'password'

account_api = killbill.api.AccountApi()
body = killbill.models.payment_method.PaymentMethod(plugin_name='__EXTERNAL_PAYMENT__')
account_api.create_payment_method('1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8',
                                  body,
                                  'tutorial',
                                  'bob',
                                  'lazar',
                                  is_default=True)
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="go-step4" role="tabpanel" aria-labelledby="go-tab-step4">
++++
[source,go]
----
import (
	"context"
	"encoding/base64"
	"github.com/go-openapi/runtime"
	httptransport "github.com/go-openapi/runtime/client"
	"github.com/go-openapi/strfmt"
	"github.com/killbill/kbcli/kbclient"
	"github.com/killbill/kbcli/kbclient/account"
	"github.com/killbill/kbcli/kbmodel"
)

trp := httptransport.New("127.0.0.1:8080", "", nil)

authWriter := runtime.ClientAuthInfoWriterFunc(
	func(r runtime.ClientRequest, _ strfmt.Registry) error {
		encoded := base64.StdEncoding.EncodeToString([]byte("admin:password"))
		if err := r.SetHeaderParam("Authorization", "Basic "+encoded); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiKey", "bob"); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiSecret", "lazar"); err != nil {
			return err
		}
		return nil
	})

createdBy := "tutorial"
defaults := kbclient.KillbillDefaults{
	CreatedBy: &createdBy,
}

client := kbclient.New(trp, strfmt.Default, authWriter, defaults)
body := &kbmodel.PaymentMethod{
	PluginName: "__EXTERNAL_PAYMENT__",
}

isDefault := true
pm, err := client.Account.CreatePaymentMethod(
	context.Background(),
	&account.CreatePaymentMethodParams{
		Body:                  body,
		AccountID:             "1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8",
		IsDefault:             &isDefault,
		ProcessLocationHeader: true,
	})
if err == nil {
	print(pm.GetPayload().PaymentMethodID)
}
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="php-step4" role="tabpanel" aria-labelledby="php-tab-step4">
++++
[source,php]
----
require_once(__DIR__ . '/vendor/autoload.php');

$config = Killbill\Client\Swagger\Configuration::getDefaultConfiguration();
$config->setHost('http://127.0.0.1:8080')
       ->setUsername('admin')
       ->setPassword('password')
       ->setApiKey('X-Killbill-ApiKey', 'bob')
       ->setApiKey('X-Killbill-ApiSecret', 'lazar');

$accountApi = new Killbill\Client\Swagger\Api\AccountApi(null, $config);

$pmData = new Killbill\Client\Swagger\Model\PaymentMethod();
$pmData->setPluginName('__EXTERNAL_PAYMENT__');

$pm = $accountApi->createPaymentMethod(
                     $pmData,
                     'tutorial',
                     '1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8',
                     NULL,
                     NULL,
                     $default = 'true'
                   );
----
++++
  </div>
</div>
++++

[step5]
== Step 5. Set Up a Subscription for the Account

You are now ready to create a https://docs.killbill.io/latest/Kill-Bill-Glossary.html#subscription[subscription^] for the customer.

[NOTE]
*Note:* Replace `1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8` below with the ID of your account. Also, `planName` must match the plan name in the catalog.

++++
<ul class="nav nav-tabs" id="tutorial-step3" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step5" data-toggle="tab" href="#curl-step5" role="tab" aria-controls="curl-step5" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step5" data-toggle="tab" href="#java-step5" role="tab" aria-controls="java-step5" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step5" data-toggle="tab" href="#ruby-step5" role="tab" aria-controls="ruby-step5" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step5" data-toggle="tab" href="#python-step5" role="tab" aria-controls="python-step5" aria-selected="false">Python</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="go-tab-step5" data-toggle="tab" href="#go-step5" role="tab" aria-controls="go-step5" aria-selected="false">Go</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="php-tab-step5" data-toggle="tab" href="#php-step5" role="tab" aria-controls="php-step5" aria-selected="false">PHP</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step5">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step5" role="tabpanel" aria-labelledby="curl-tab-step5">
++++
[source,bash]
----
curl -v \
     -X POST \
     -u admin:password \
     -H 'X-Killbill-ApiKey: bob' \
     -H 'X-Killbill-ApiSecret: lazar' \
     -H 'X-Killbill-CreatedBy: tutorial' \
     -H 'Content-Type: application/json' \
     -d '{
            "accountId": "1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8",
            "planName": "standard-monthly"
         }' \
     http://127.0.0.1:8080/1.0/kb/subscriptions
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="java-step5" role="tabpanel" aria-labelledby="java-tab-step5">
++++
[source,java]
----
import java.util.UUID;

import org.killbill.billing.client.KillBillClientException;
import org.killbill.billing.client.KillBillHttpClient;
import org.killbill.billing.client.RequestOptions;
import org.killbill.billing.client.api.gen.SubscriptionApi;
import org.killbill.billing.client.model.gen.Subscription;

KillBillHttpClient client = new KillBillHttpClient("http://127.0.0.1:8080",
                                                   "admin",
                                                   "password",
                                                   "bob",
                                                   "lazar");
SubscriptionApi subscriptionApi = new SubscriptionApi(client);

UUID accountId = UUID.fromString("1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8");
Subscription body = new Subscription();
body.setAccountId(accountId);
body.setPlanName("standard-monthly");

RequestOptions requestOptions = RequestOptions.builder()
                                              .withCreatedBy("tutorial")
                                              .build();
Subscription subscription = subscriptionApi.createSubscription(body,
                                                               null,
                                                               null,
                                                               null,
                                                               requestOptions);
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="ruby-step5" role="tabpanel" aria-labelledby="ruby-tab-step5">
++++
[source,ruby]
----
require 'killbill_client'

KillBillClient.url = 'http://127.0.0.1:8080'

options = {
  :username => 'admin',
  :password => 'password',
  :api_key => 'bob',
  :api_secret => 'lazar'
}

body = KillBillClient::Model::Subscription.new
body.account_id  = '1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8'
body.plan_name = 'standard-monthly'

subscription = body.create('tutorial',
                           nil,
                           nil,
                           nil,
                           false,
                           options)
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="python-step5" role="tabpanel" aria-labelledby="python-tab-step5">
++++
[source,python]
----
import killbill

killbill.configuration.base_uri = 'http://127.0.0.1:8080'
killbill.configuration.username = 'admin'
killbill.configuration.password = 'password'

subscription_api = killbill.api.SubscriptionApi()
body = killbill.models.subscription.Subscription(account_id='1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8',
                                                 plan_name='standard-monthly')

subscription_api.create_subscription(body,
                                     'tutorial',
                                     'bob',
                                     'lazar')
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="go-step5" role="tabpanel" aria-labelledby="go-tab-step5">
++++
[source,go]
----
import (
	"context"
	"encoding/base64"
	"github.com/go-openapi/runtime"
	httptransport "github.com/go-openapi/runtime/client"
	"github.com/go-openapi/strfmt"
	"github.com/killbill/kbcli/kbclient"
	"github.com/killbill/kbcli/kbclient/subscription"
	"github.com/killbill/kbcli/kbmodel"
)

trp := httptransport.New("127.0.0.1:8080", "", nil)

authWriter := runtime.ClientAuthInfoWriterFunc(
	func(r runtime.ClientRequest, _ strfmt.Registry) error {
		encoded := base64.StdEncoding.EncodeToString([]byte("admin:password"))
		if err := r.SetHeaderParam("Authorization", "Basic "+encoded); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiKey", "bob"); err != nil {
			return err
		}
		if err := r.SetHeaderParam("X-KillBill-ApiSecret", "lazar"); err != nil {
			return err
		}
		return nil
	})

createdBy := "tutorial"
defaults := kbclient.KillbillDefaults{
	CreatedBy: &createdBy,
}

client := kbclient.New(trp, strfmt.Default, authWriter, defaults)
planName := "standard-monthly"
body := &kbmodel.Subscription{
	AccountID: "1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8",
	PlanName:  &planName,
}

sub, err := client.Subscription.CreateSubscription(
	context.Background(),
	&subscription.CreateSubscriptionParams{
		Body:                  body,
		ProcessLocationHeader: true,
	})
if err == nil {
	print(sub.GetPayload().SubscriptionID)
}
----
++++
  </div>
  <div class="tutorial-tab tab-pane fade" id="php-step5" role="tabpanel" aria-labelledby="php-tab-step5">
++++
[source,php]
----
require_once(__DIR__ . '/vendor/autoload.php');

$config = Killbill\Client\Swagger\Configuration::getDefaultConfiguration();
$config->setHost('http://127.0.0.1:8080')
       ->setUsername('admin')
       ->setPassword('password')
       ->setApiKey('X-Killbill-ApiKey', 'bob')
       ->setApiKey('X-Killbill-ApiSecret', 'lazar');

$subscriptionApi = new Killbill\Client\Swagger\Api\SubscriptionApi(null, $config);

$subData = new Killbill\Client\Swagger\Model\Subscription();
$subData->setAccountId('1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8');
$subData->setPlanName('standard-monthly');

$sub = $subscriptionApi->createSubscription(
                           $subData,
                           'tutorial',
                           NULL,
                           NULL
                         );
----
++++
  </div>
</div>
++++

[step6]
== Step 6. View the Generated Invoice

To view the invoice that Kill Bill automatically generated for the subscription (step 5), see the following tabs.

For examples of responses, see https://killbill.github.io/slate/?java#account-retrieve-account-invoices[Retrieve Account Invoices] in the API.

[NOTE]
*Note:* Replace `1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8` below with the ID of your account.

//should probably list response in this section

++++
<ul class="nav nav-tabs" id="tutorial-step6" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="curl-tab-step6" data-toggle="tab" href="#curl-step6" role="tab" aria-controls="curl-step6" aria-selected="true">cURL</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="java-tab-step6" data-toggle="tab" href="#java-step6" role="tab" aria-controls="java-step6" aria-selected="false">Java</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="ruby-tab-step6" data-toggle="tab" href="#ruby-step6" role="tab" aria-controls="ruby-step6" aria-selected="false">Ruby</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="python-tab-step6" data-toggle="tab" href="#python-step6" role="tab" aria-controls="python-step6" aria-selected="false">Python</a>
  </li>
</ul>
<div class="tab-content" id="tutorial-content-step1">
  <div class="tutorial-tab tab-pane fade show active" id="curl-step6" role="tabpanel" aria-labelledby="curl-tab-step6">
++++
[source,bash]
----
curl -v \
    -u admin:password \
    -H "X-Killbill-ApiKey: bob" \
    -H "X-Killbill-ApiSecret: lazar" \
    -H "Accept: application/json" \
    "http://127.0.0.1:8080/1.0/kb/accounts/1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8/invoices"
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="java-step6" role="tabpanel" aria-labelledby="java-tab-step6">
++++
[source,java]
----
import org.killbill.billing.client.api.gen.AccountApi;
protected AccountApi accountApi;

UUID accountId = UUID.fromString("1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8");
LocalDate startDate = null;
LocalDate endDate = null;
Boolean withMigrationInvoices = false; // Will not fetch migrated invoice - if any
Boolean unpaidInvoicesOnly = false; // Will not restrict to unpaid invoices
Boolean includeVoidedInvoices = false; // Will not include void invoices
String invoicesFilter = null;
Invoices invoices = accountApi.getInvoicesForAccount(accountId,
                                                     startDate, 
                                                     endDate,
                                                     withMigrationInvoices, 
                                                     unpaidInvoicesOnly, 
                                                     includeVoidedInvoices, 
                                                     invoicesFilter,
                                                     AuditLevel.FULL, 
                                                     requestOptions);
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="ruby-step6" role="tabpanel" aria-labelledby="ruby-tab-step6">
++++
[source,ruby]
----
account.invoices(with_items,
                 options)
----
++++
</div>
<div class="tutorial-tab tab-pane fade" id="python-step6" role="tabpanel" aria-labelledby="python-tab-step6">
++++
[source,python]
----
accountApi = killbill.api.AccountApi()
account_id = '1cb6c8b0-1df6-4dd5-9c7c-2a69bab365e8'

accountApi.get_invoices_for_account(account_id, api_key, api_secret)
----
++++
  </div>
</div>
++++